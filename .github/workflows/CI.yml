name: CI

on:
  pull_request:
    paths:
      - '.github/workflows/CI.yml'
      - 'src/**'
      - 'examples/**'
      - 'acinclude.m4'
      - 'bootstrap.sh'
      - 'CMakeLists.txt'
      - 'config/**'
      - 'configure.ac'
      - 'Makefile.in'
  push:
    paths:
      - '.github/workflows/CI.yml'
      - 'src/**'
      - 'examples/**'
      - 'acinclude.m4'
      - 'bootstrap.sh'
      - 'CMakeLists.txt'
      - 'config/**'
      - 'configure.ac'
      - 'Makefile.in'

env:
  GLOBAL_MULTIPLIER: 1

concurrency:
  # Group by workflow and ref, and to limit to 1 concurrent job except for main
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.ref != 'refs/heads/main' || github.run_number }}
  # Cancel intermediate builds for pull requests
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  assert-ntl-msolve-nemo:
    name: NTL, msolve and Nemo.jl
    runs-on: ubuntu-24.04
    env:
      CC: "gcc"
      TESTCOEFF: "0.1"
    steps:
      - uses: actions/checkout@v5
      - name: "Setup"
        run: |
          sudo apt-get install -y libgmp-dev libmpfr-dev libntl-dev autoconf libtool-bin
          $CC --version
          make --version
          autoconf --version
          libtool --version
          julia --version
          echo "MAKE=make -j$(expr $(nproc) + 1) --output-sync=target" >> $GITHUB_ENV
      - name: "Build FLINT for msolve"
        run: |
          ./bootstrap.sh && ./configure CC=${CC} --with-ntl --enable-assert
          $MAKE && sudo make install && sudo ldconfig
      - name: "Test msolve"
        run: |
          git clone --depth=1 https://github.com/algebraic-solving/msolve
          cd msolve/ && ./autogen.sh && ./configure && $MAKE && make check
      - name: "Build FLINT for Nemo"
        run: |
          gmp_path=$(julia -e 'include("dev/find_gmp_mpfr.jl"); print(gmp_artifact_dir())')
          mpfr_path=$(julia -e 'include("dev/find_gmp_mpfr.jl"); print(mpfr_artifact_dir())')
          echo "Path to GMP and MPFR: ${gmp_path}, ${mpfr_path}"
          ./bootstrap.sh && ./configure CC=${CC} --with-gmp=$gmp_path --with-mpfr=$mpfr_path && $MAKE
          mkdir lib
          cp libflint.so* lib/
      - name: "Test Nemo.jl"
        run: |
          git clone --depth 1 https://github.com/Nemocas/Nemo.jl.git
          mkdir -p ~/.julia/artifacts
          echo -e "[e134572f-a0d5-539d-bddf-3cad8db41a82]\nFLINT = \"$(pwd)\"" > ~/.julia/artifacts/Overrides.toml
          julia -e "import Pkg; Pkg.develop(path=\"./Nemo.jl\"); Pkg.test(\"Nemo\")"

